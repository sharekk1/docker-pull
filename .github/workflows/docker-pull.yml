name: æ‰¹é‡é•œåƒåŒæ­¥

on:
  workflow_dispatch:
    inputs:
      TARGET_REGISTRY:
        description: 'ä»“åº“åœ°å€'
        required: true
        default: 'swr.cn-south-1.myhuaweicloud.com'
      TARGET_REPOSITORY:
        description: 'ç©ºé—´åç§°'
        required: true
        default: 'kehang'
      ARCH:
        description: 'ç³»ç»Ÿæ¶æ„'
        required: true
        default: 'amd64'
        type: choice
        options:
          - amd64
          - arm64
          - arm/v7
          - arm/v6
          - 386
          - s390x
          - ppc64le

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v2

      - name: ç™»å½•åˆ°åä¸ºäº‘ACR
        id: login
        env:
          ACR_USERNAME: cn-south-1@YNRH4VJ88CVFYLAADKLQ
          ACR_PASSWORD: 66ea1b435399a90247838f0d3cd049b9ff1300b91a4c8dd0102cc58c91a3a965
        run: |
          docker login -u $ACR_USERNAME -p $ACR_PASSWORD ${{ inputs.TARGET_REGISTRY }}

      - name: è¯»å–é•œåƒåˆ—è¡¨æ–‡ä»¶
        id: read_images
        run: |
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f images.txt ]; then
            echo "âŒ é•œåƒåˆ—è¡¨æ–‡ä»¶ images.txt æœªæ‰¾åˆ°"
            exit 1
          fi
          
          # è¾“å‡ºæ–‡ä»¶å†…å®¹ä¾›è°ƒè¯•
          echo "ğŸ“‹ é•œåƒåˆ—è¡¨å†…å®¹ï¼š"
          cat images.txt
          echo "------------------------------------"

      - name: æ‰¹é‡åŒæ­¥é•œåƒ
        id: sync_images
        run: |
          while IFS=',' read -r src_image dst_image; do
            # å»é™¤é¦–å°¾ç©ºæ ¼
            src_image=$(echo $src_image | xargs)
            dst_image=$(echo $dst_image | xargs)

            echo "ğŸ”„ æ­£åœ¨å¤„ç†é•œåƒå¯¹: $src_image â†’ $dst_image"
            
            # å®Œæ•´ç›®æ ‡é•œåƒåœ°å€
            target_image="${{ inputs.TARGET_REGISTRY }}/${{ inputs.TARGET_REPOSITORY }}/$dst_image"

            # æ‹‰å–é•œåƒ
            echo "â¬‡ï¸  æ‹‰å–é•œåƒ: $src_image"
            docker pull --platform ${{ inputs.ARCH }} $src_image

            # é‡æ–°æ‰“æ ‡ç­¾
            echo "ğŸ·ï¸  æ ‡è®°é•œåƒ: $target_image"
            docker tag $src_image $target_image

            # æ¨é€é•œåƒ
            echo "â¬†ï¸  æ¨é€é•œåƒ: $target_image"
            docker push $target_image

            echo "âœ… å®Œæˆ: $src_image â†’ $target_image"
            echo "------------------------------------"
          done < images.txt

      - name: æ¸…ç†å·¥ä½œç¯å¢ƒ
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶é•œåƒ..."
          docker image prune -a -f

